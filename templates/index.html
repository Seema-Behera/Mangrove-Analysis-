<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet Draw Example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Leaflet.draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.choropleth/0.3.0/leaflet.choropleth.min.js"></script> -->
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">

    <!-- CSS code -->
  <style>
    #mapid {
      height: 680px;
    }
    body {
          background-image: url("{{ url_for('static', filename='Mangrove_Img.jpg') }}");
          background-repeat: no-repeat;
          background-attachment: fixed;
          background-size: cover;
          background-color: whitesmoke!important;
        }
    input,
    select{
         background-color: transparent !important;
         color: white !important;
    }
    label{
      color: white;
    }
    
    /* header {
      display: none;
      opacity: 0;
      transition: opacity 1s;
      margin-top: 1.5rem;
      position: absolute;
      text-align: center;
      width: 80%;
    } */
  
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  <!-- Navigation bar -->
  <!-- <nav class="navbar navbar-expand-sm  fixed-top" style="background-color: #0000007c; text-align: center;">
 <h3>Mangroves Analysis In Gujarat </h3>
  </nav> -->
  <br><header><div style="text-align: center; color: white;"><h1>Mangroves Analysis In Gujarat </h1></div></header>
 
  <div class="container-fluid" style="margin-top: 1.5%;">
  <div class="row">
  <div class="col">
   <!-- Dropdown to select index -->
  <form id="userForm" class="mt-4"> <!-- Added form element with id "userForm" -->
    
    <div class="mb-3">
      <label for="type">Select type:</label>
      <select class="form-control" name="type" id="type" required>
          <option selected disabled>Choose a type</option>
          <option value="mvi">MVI-(Mangrove Vegetation Index)</option>
          <option value="ndvi">NDVI-(Normalized Vegetation Index)</option>
          <option value="change">MANGROVE CHANGE</option>
      </select>
    </div>
    <div class="row input-group mb-3 mx-0">
      <span class=" input-group-text" >From Date</span>
      <input type="date" class=" form-control" name="fromdate" />
      <span class="input-group-text ">To Date</span>
      <input type="date" class=" form-control" name="todate" />
    </div>
  </form>

  <div id="lat_lon" class="text-center mt-4"></div>
  <div id="Analysis" style="overflow-y: scroll; height: 250px; margin-top: 100px;">
  <div class="row">
    <div id="imgcont" class="col" style="width: 48%;">   
      <!-- {% if img %}
      <h1>NDVI PLOT</h1>
      {% endif %} -->
    </div>

    <div id="chartcont" class="col" style="width: 48%;">
    </div></div>
    <!-- <p id="progress-bar"></p> -->
    <div id="loader" class="text-primary d-block mx-auto my-5 d-none" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>
<div class="col">
  <div id="mapid" style="height: 400px;"></div>     <!--shows leaflet map -->
  <div id="plots" style="overflow-y: scroll; height: 450px;">
    <div id="popup-container" class="popup">
      <span onclick="togglePopup()" style="cursor: pointer; float: right;">Close</span>
     
      <div id="mangrove_area">
        <br>
      <img id="plot-img" src="{{ url_for('static', filename='plot.png') }}" alt="Mangrove Area Changes">
      </div>
      
      <div id="types">
      <br>
      <br>
      
      <img id="plot1-img" src="{{ url_for('static', filename='plot1.png') }}" alt="Mangrove Types">
      </div>
      
      <div id="health">
        <br>
      <br>
      <br>
      <img id="plot2-img" src="{{ url_for('static', filename='plot2.png') }}" alt="Mangrove Health">
      </div>
  </div>
  </div>
</div>
</div>

<br><br><br>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>


  
  <script>
    var map = L.map('mapid').setView([22.390472, 69.628927], 10); //setting Map area to be displayed
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>' //Open streetmap API 
    }).addTo(map);
    
    var latlng = L.latLng(22.390472, 69.628927);
    
    var drawnItems = L.featureGroup().addTo(map);

    // create a Rectangle draw handler
    var drawControl = new L.Control.Draw({
      draw: {
        rectangle: {
          shapeOptions: {
            color: '#ffcc33',
            weight: 3
          }
        },
        polygon: false,
        circle: false,
        marker: false,
        polyline: false,
        circlemarker: false
      },
      edit: {
        featureGroup: drawnItems
      }
    }).addTo(map);

    function getRandomColor() {
      var letters = '0123456789ABCDEF';
      var color = '#';
      for (var i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }

    function handleOnChange(e) {
      console.log(e.target.value)
    }

    // when a rectangle is drawn, add it to the drawnItems feature group
    map.on('draw:created', function (e) {
      var layer = e.layer;
      layer.options.color = getRandomColor();
      drawnItems.addLayer(layer);
      drawControl.remove();
      drawControl.addTo(map);
      var type = document.getElementById("type").value;
      var type1 = document.getElementsByName("fromdate")[0];
      var type2 = document.getElementsByName("todate")[0];
      // get the coordinates of the selected area
      let coordinates = layer.getLatLngs();
      console.log(coordinates)
      let lat_min = coordinates[0][0]["lat"];
      let lat_max = coordinates[0][1]["lat"];
      let lng_min = coordinates[0][0]["lng"];
      let lng_max = coordinates[0][2]["lng"];
      let data = {
        lat_min: lat_min,
        lat_max: lat_max,
        lng_min: lng_min,
        lng_max: lng_max,
        t: type,
        t1: type1.value,
        t2: type2.value
      }

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/my_flask_route", true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.responseType = "json";

      document.getElementById("loader").classList.remove("d-none")
      xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.UNSENT) {
          console.log("In Progress");
        } else if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            // Process the response here
            if (xhr.response.error) {
              document.getElementById("loader").classList.add("d-none")
              document.getElementById('imgcont').innerHTML = xhr.response.status;
            }
            else {
              const mangroveData = xhr.response.mangrove_data;
  const yearData = xhr.response.year_data;

 

  // Draw the image
  const imgContainer = document.createElement('div');
  const heading = document.createElement('h3');
  if (type == 'ndvi') {
    heading.textContent = 'NDVI PLOT';
  } else if (type == 'mvi') {
    heading.textContent = 'MVI PLOT';
  }
  else{
    heading.textContent = 'Mangrove Change';
  }
  heading.style.color="white";
  imgContainer.appendChild(heading);
  const img = document.createElement('img');
  img.src = 'data:image/png;base64,' + xhr.response.image;
  img.style.border = `3px solid ${layer.options.color}`;
  img.style.width='100%';
  img.style.height='210px';
  imgContainer.appendChild(img);

  // Add the image element to the document body
  document.getElementById('imgcont').appendChild(imgContainer);


  // chartContainer.appendChild(chartCanvas);
  const chartCanvas = document.createElement('canvas');
  chartCanvas.style.backgroundColor="white";
  chartCanvas.style.marginTop="60px";
  // chartCanvas.style.marginBottom="90px";
  chartCanvas.id = 'myChart';
  
const chartContainer = document.createElement('div');

chartContainer.appendChild(chartCanvas);
document.getElementById('chartcont').appendChild(chartContainer);

  // Create the chart using Chart.js
  new Chart(chartCanvas, {
    type: 'bar',
    data: {
      labels: yearData,
      datasets: [{
        label: 'Mangrove',
        labelColor: '',
        data: mangroveData,
        backgroundColor: `${layer.options.color}`,  //'rgba(0, 123, 255, 0.5)'
        borderColor:`${layer.options.color}`, 
        borderWidth: 3,
        pointRadius: 3,
        pointBackgroundColor: 'rgba(0, 123, 255, 1)',
        pointBorderColor: 'rgba(0, 0, 0, 0)',
        pointHoverRadius: 5,
        pointHoverBackgroundColor: 'rgba(0, 123, 255, 1)',
        pointHoverBorderColor: 'rgba(0, 0, 0, 0)',
        
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }    
    }
  });
            }
          }
        }
      }
      xhr.send(JSON.stringify(data));

});

        // Added event listener for form submission
        document.getElementById("userForm").addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent the form from submitting and refreshing the page


       // Get the input values
    var latitude = document.getElementById("latitude").value;
    var longitude = document.getElementById("longitude").value;
    var buffer = document.getElementById("buffer").value;
    var type = document.getElementById("type").value;
    var type1 = document.getElementsByName("fromdate")[0];
    var type2 = document.getElementsByName("todate")[0];
    // Create the data object to send to the Flask application
    var data = {
      lat_min: parseFloat(latitude) - parseFloat(buffer),
      lat_max: parseFloat(latitude) + parseFloat(buffer),
      lng_min: parseFloat(longitude) - parseFloat(buffer),
      lng_max: parseFloat(longitude) + parseFloat(buffer),
      t: type,
      t1: type1.value,
      t2: type2.value
    };
    console.log(latitude)
    document.getElementById("loader").classList.remove("d-none")
    // Send the data to the Flask application using AJAX
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/my_flask_route", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.responseType = "json";

    document.getElementById("loader").classList.remove("d-none")
      xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.UNSENT) {
          console.log("In Progress");
        } else if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            // Process the response here
            if (xhr.response.error) {
              document.getElementById("loader").classList.add("d-none")
              document.getElementById('imgcont').innerHTML = xhr.response.status;
            }
            else {
              document.getElementById("loader").classList.add("d-none")
              const imgContainer = document.createElement('div');
              const heading = document.createElement('h3');
             
             const mangroveData = xhr.response.mangrove_data;
  const yearData = xhr.response.year_data;

  // Draw the image
 
  if (type == 'ndvi') {
    heading.textContent = 'NDVI PLOT';
  } else if (type == 'mvi') {
    heading.textContent = 'MVI PLOT';
  }
  imgContainer.appendChild(heading);
  const img = document.createElement('img');
  img.src = 'data:image/png;base64,' + xhr.response.image;
  img.style.border = `3px solid ${layer.options.color}`;
  imgContainer.appendChild(img);

  // Add the image element to the document body
  document.getElementById('imgcont').appendChild(imgContainer);

  // Draw the chart
  const chartContainer = document.createElement('div');
  const chartCanvas = document.createElement('canvas');
  chartCanvas.id = 'myChart';
  chartContainer.appendChild(chartCanvas);
  document.getElementById('imgcont').appendChild(chartContainer);

  // Create the chart using Chart.js
  new Chart(chartCanvas, {
    type: 'bar',
    data: {
      labels: yearData,
      datasets: [{
        label: 'Mangrove',
        data: mangroveData,
        backgroundColor: 'rgba(255,255,255,1)',
        borderColor: 'rgba(255,255,255,1)',
        borderWidth: 1,
        pointRadius: 3,
        pointBackgroundColor: 'rgba(0, 123, 255, 1)',
        pointBorderColor: 'rgba(0, 0, 0, 0)',
        pointHoverRadius: 5,
        pointHoverBackgroundColor: 'rgba(0, 123, 255, 1)',
        pointHoverBorderColor: 'rgba(0, 0, 0, 0)',
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

          }
        }
      };

      xhr.send(JSON.stringify(data));

    });

  </script>
  <script>
    
  </script>
  <script>
    function togglePopup() {
        var popupContainer = document.getElementById('popup-container');

        if (popupContainer.style.display === 'none') {
            popupContainer.style.display = 'block';
        } else {
            popupContainer.style.display = 'none';
        }
    }
</script>
<script>
  
</script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"
  integrity="sha384-zYPOMqeu1DAVkHiLqWBUTcbYfZ8osu1Nd6Z89ify25QV9guujx43ITvfi12/QExE"
  crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.min.js"
  integrity="sha384-Y4oOpwW3duJdCWv5ly8SCFYWqFDsfob/3GkgExXKV4idmbt98QcxXYs9UoXAB7BZ"
  crossorigin="anonymous"></script>
</body>

</html>